<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generador de Fixtures Deportivos</title>
  <!-- Estilos en línea para evitar problemas de carga -->
  <style>
    /* Estilos básicos para el generador de fixtures */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #fdfdfd;
      color: #333;
    }

    h1 {
      margin: 0;
      padding: 20px;
      background-color: #004080;
      color: white;
      text-align: center;
    }

    .config {
      background-color: #eef2fa;
      padding: 10px 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border-bottom: 1px solid #ccd6eb;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }

    label {
      font-weight: bold;
    }

    .container {
      display: flex;
      flex-direction: row;
      gap: 20px;
      padding: 20px;
    }

    .match-list {
      flex: 0 0 25%;
      max-height: 75vh;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      background-color: #fafafa;
    }

    .match-list h2 {
      margin-top: 0;
    }

    .schedule-container {
      flex: 1;
      overflow-x: auto;
      border: 1px solid #ccc;
      padding: 10px;
      background-color: #fafafa;
    }

    .schedule-container h2 {
      margin-top: 0;
    }

    .match-card {
      background-color: #eaeaea;
      border: 1px solid #aaa;
      border-radius: 4px;
      padding: 6px;
      margin-bottom: 6px;
      cursor: grab;
      user-select: none;
    }

    .match-card:active {
      cursor: grabbing;
    }

    .placeholder {
      color: #666;
      font-style: italic;
    }

    table.schedule-day {
      border-collapse: collapse;
      margin-bottom: 30px;
      width: 100%;
      table-layout: fixed;
    }

    table.schedule-day caption {
      font-weight: bold;
      margin-bottom: 5px;
    }

    table.schedule-day th,
    table.schedule-day td {
      border: 1px solid #999;
      padding: 4px;
      text-align: center;
      width: 100px;
      height: 50px;
      overflow: hidden;
    }

    table.schedule-day th {
      background-color: #dde6f7;
    }

    td.timeslot {
      background-color: #f9f9f9;
      cursor: pointer;
      position: relative;
    }

    td.timeslot.filled {
      color: #003300;
      font-weight: bold;
    }

    /* Número de slot en la esquina superior izquierda */
    td.timeslot .slot-number {
      position: absolute;
      top: 2px;
      left: 2px;
      font-size: 0.7em;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>Generador de Fixtures Deportivos</h1>

  <section id="config" class="config">
    <div class="form-row">
      <label for="teams_file">Archivo de equipos (CSV):</label>
      <input type="file" id="teams_file" accept=".csv">
      <button id="upload-btn">Cargar Equipos</button>
    </div>
    <div class="form-row">
      <label for="system">Sistema:</label>
      <select id="system">
        <option value="8x3">8x3</option>
        <option value="4x6">4x6</option>
        <option value="rr">Round Robin</option>
      </select>
      <label for="home_and_away">
        <input type="checkbox" id="home_and_away"> Ida y vuelta
      </label>
    </div>
    <div class="form-row">
      <label for="days">Días:</label>
      <input type="number" id="days" value="5" min="1">
      <label for="fields">Canchas:</label>
      <input type="number" id="fields" value="2" min="1">
      <label for="match_duration">Duración (min):</label>
      <input type="number" id="match_duration" value="60" min="1">
    </div>
    <div class="form-row">
      <label for="start_time">Inicio:</label>
      <input type="time" id="start_time" value="09:00">
      <label for="end_time">Fin:</label>
      <input type="time" id="end_time" value="18:00">
      <label for="midday_break">Pausa mediodía:</label>
      <input type="text" id="midday_break" placeholder="12:00,14:00">
    </div>
    <div class="form-row">
      <button id="generate-btn">Generar horarios y partidos</button>
    </div>
  </section>

  <div class="container">
    <div id="match-list" class="match-list">
      <h2>Partidos</h2>
      <p class="placeholder">Importe equipos y genere para ver los partidos.</p>
    </div>
    <div id="schedule-container" class="schedule-container">
      <h2>Horarios</h2>
      <p class="placeholder">Genere horarios para ver la tabla.</p>
    </div>
  </div>

  <!-- Código JavaScript en línea para evitar problemas de carga -->
  <script>
    // URL base del backend (se deja vacío porque se sirve en el mismo host)
    const BASE_URL = '';

    // Paleta de colores por zona
    const zoneColors = {
      'A': '#ffd966', // amarillo
      'B': '#9fc5e8', // azul claro
      'C': '#f4b084', // naranja
      'D': '#a2c4c9', // azul grisáceo
      'E': '#b7b7b7', // gris
      'F': '#8e7cc3', // violeta
      'G': '#93c47d', // verde
      'H': '#c27ba0'  // rosa
    };

    const uploadBtn = document.getElementById('upload-btn');
    const generateBtn = document.getElementById('generate-btn');
    const teamsFileInput = document.getElementById('teams_file');
    const matchListDiv = document.getElementById('match-list');
    const scheduleContainer = document.getElementById('schedule-container');

    let teamsLoaded = false;
    let draggedCard = null;

    // Subir CSV de equipos al backend
    uploadBtn.addEventListener('click', async () => {
      const file = teamsFileInput.files[0];
      if (!file) {
        alert('Seleccione un archivo CSV de equipos.');
        return;
      }
      const formData = new FormData();
      formData.append('file', file, file.name);
      try {
        const res = await fetch(`${BASE_URL}/import_teams`, {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        if (!res.ok) {
          alert(data.error || 'Error al cargar equipos');
          return;
        }
        teamsLoaded = true;
        matchListDiv.innerHTML = '<h2>Partidos</h2><p class="placeholder">Genere horarios para ver los partidos.</p>';
        alert(`Se cargaron ${data.teams.length} equipos.`);
      } catch (err) {
        console.error(err);
        alert('Error de red al cargar equipos');
      }
    });

    // Generar horarios y lista de partidos
    generateBtn.addEventListener('click', async () => {
      if (!teamsLoaded) {
        alert('Primero cargue un archivo CSV de equipos.');
        return;
      }
      const system = document.getElementById('system').value;
      const homeAndAway = document.getElementById('home_and_away').checked;
      const days = parseInt(document.getElementById('days').value, 10);
      const fields = parseInt(document.getElementById('fields').value, 10);
      const matchDuration = parseInt(document.getElementById('match_duration').value, 10);
      const startTime = document.getElementById('start_time').value;
      const endTime = document.getElementById('end_time').value;
      const middayInput = document.getElementById('midday_break').value.trim();
      let middayBreak = null;
      if (middayInput) {
        const parts = middayInput.split(',');
        if (parts.length === 2) {
          middayBreak = [parts[0].trim(), parts[1].trim()];
        }
      }
      const body = {
        system: system,
        days: days,
        fields: fields,
        start_time: startTime,
        end_time: endTime,
        match_duration: matchDuration,
        home_and_away: homeAndAway,
      };
      if (middayBreak) body.midday_break = middayBreak;
      try {
        const res = await fetch(`${BASE_URL}/generate_parts`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) {
          alert(data.error || 'Error al generar datos');
          return;
        }
        renderMatches(data.matches);
        renderSchedule(data.timeslots, fields, matchDuration);
      } catch (err) {
        console.error(err);
        alert('Error de red al generar datos');
      }
    });

    // Renderiza la lista de partidos como tarjetas arrastrables
    function renderMatches(matches) {
      matchListDiv.innerHTML = '<h2>Partidos</h2>';
      if (!matches || matches.length === 0) {
        const p = document.createElement('p');
        p.textContent = 'No hay partidos disponibles.';
        matchListDiv.appendChild(p);
        return;
      }
      matches.forEach((m) => {
        const card = document.createElement('div');
        card.className = 'match-card';
        card.draggable = true;
        // Guardar datos para restricciones
        card.dataset.home = m.home;
        card.dataset.away = m.away;
        card.dataset.zone = m.zone;
        card.dataset.round = m.round;
        card.innerHTML = `<strong>${m.home} vs ${m.away}</strong><br><small>Zona ${m.zone}, Ronda ${m.round}</small>`;
        // Asignar color según la zona
        const color = zoneColors[m.zone] || '#dddddd';
        card.style.backgroundColor = color;
        card.addEventListener('dragstart', handleDragStart);
        matchListDiv.appendChild(card);
      });
    }

    // Renderiza la tabla de horarios por día y cancha
    function renderSchedule(timeslots, fieldsCount, matchDuration) {
      scheduleContainer.innerHTML = '<h2>Horarios</h2>';
      if (!timeslots || timeslots.length === 0) {
        const p = document.createElement('p');
        p.textContent = 'No se generaron horarios.';
        scheduleContainer.appendChild(p);
        return;
      }
      // Agrupar slots por día
      const byDay = {};
      timeslots.forEach((ts) => {
        if (!byDay[ts.day]) byDay[ts.day] = [];
        byDay[ts.day].push(ts);
      });
      Object.keys(byDay).forEach((day) => {
        const slots = byDay[day];
        // Crear enumeración local para numerar los slots del día
        const enumeration = {};
        slots.forEach((slot, idx) => {
          enumeration[slot.index] = idx + 1;
        });
        // Obtener campos y horarios únicos en orden
        const fields = [...new Set(slots.map((s) => s.field))];
        const times = [...new Set(slots.map((s) => s.time))];
        // Ordenar las horas
        times.sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
        // Construir tabla
        const table = document.createElement('table');
        table.className = 'schedule-day';
        const caption = document.createElement('caption');
        caption.textContent = `Día ${day}`;
        table.appendChild(caption);
        // Cabecera
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        const emptyTh = document.createElement('th');
        emptyTh.textContent = '';
        trh.appendChild(emptyTh);
        fields.forEach((field) => {
          const th = document.createElement('th');
          th.textContent = field;
          trh.appendChild(th);
        });
        thead.appendChild(trh);
        table.appendChild(thead);
        // Cuerpo
        const tbody = document.createElement('tbody');
        times.forEach((time) => {
          const tr = document.createElement('tr');
          const thTime = document.createElement('th');
          thTime.textContent = time;
          tr.appendChild(thTime);
          fields.forEach((field) => {
            const td = document.createElement('td');
            td.className = 'timeslot';
            // Buscar slot correspondiente
            const slot = slots.find((s) => s.time === time && s.field === field);
            if (slot) {
              td.dataset.day = slot.day;
              td.dataset.time = slot.time;
              td.dataset.field = slot.field;
              td.dataset.index = slot.index;
              td.dataset.matchDuration = matchDuration;
              // Mostrar número de slot dentro de la celda
              const numSpan = document.createElement('span');
              numSpan.className = 'slot-number';
              numSpan.textContent = enumeration[slot.index] || '';
              td.appendChild(numSpan);
              // Eventos de drag & drop
              td.addEventListener('dragover', handleDragOver);
              td.addEventListener('drop', handleDrop);
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        scheduleContainer.appendChild(table);
      });
    }

    // Manejo de drag & drop
    function handleDragStart(ev) {
      draggedCard = this;
    }

    function handleDragOver(ev) {
      ev.preventDefault();
    }

    function handleDrop(ev) {
      ev.preventDefault();
      if (!draggedCard) return;
      const cell = this;
      // Evitar sobrescribir celdas ocupadas
      if (cell.classList.contains('filled')) {
        return;
      }
      const day = parseInt(cell.dataset.day, 10);
      const time = cell.dataset.time;
      const matchDuration = parseInt(cell.dataset.matchDuration, 10);
      const restMinutes = matchDuration; // descanso mínimo igual a duración
      const draggedHome = draggedCard.dataset.home;
      const draggedAway = draggedCard.dataset.away;
      // Comprobar si alguno de los equipos ya tiene partido cercano
      const filledSlots = document.querySelectorAll('td.timeslot.filled');
      for (const fs of filledSlots) {
        const fsDay = parseInt(fs.dataset.day, 10);
        if (fsDay !== day) continue;
        const fsTime = fs.dataset.time;
        const fsHome = fs.dataset.home;
        const fsAway = fs.dataset.away;
        // Comparar equipos
        if (fsHome === draggedHome || fsHome === draggedAway || fsAway === draggedHome || fsAway === draggedAway) {
          // Calcular diferencia de tiempo
          const diff = Math.abs(timeToMinutes(fsTime) - timeToMinutes(time));
          if (diff < restMinutes) {
            alert('No se puede asignar: el equipo ya tiene un partido cercano.');
            return;
          }
        }
      }
      // Asignar partido a la celda
      cell.classList.add('filled');
      // Aplicar color según la zona del partido
      const zone = draggedCard.dataset.zone;
      const zoneColor = zoneColors[zone] || '#cfe8cf';
      cell.style.backgroundColor = zoneColor;
      cell.innerHTML = `<strong>${draggedHome} vs ${draggedAway}</strong><br><small>Zona ${draggedCard.dataset.zone}, Ronda ${draggedCard.dataset.round}</small>`;
      cell.dataset.home = draggedHome;
      cell.dataset.away = draggedAway;
      cell.dataset.zone = draggedCard.dataset.zone;
      cell.dataset.round = draggedCard.dataset.round;
      // Eliminar tarjeta
      draggedCard.remove();
      draggedCard = null;
    }

    // Utilidades para conversión de horarios
    function timeToMinutes(t) {
      const [h, m] = t.split(':').map((v) => parseInt(v, 10));
      return h * 60 + m;
    }
  </script>
</body>
</html>